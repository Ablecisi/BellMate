<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BellMate 我的</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <link rel="stylesheet" href="./styles.css" />
    <style>
      .my-body {
        padding: 16px;
        overflow: auto;
      }
      .avatar {
        width: 68px;
        height: 68px;
        border-radius: 50%;
      }
      .log-card {
        margin-top: 12px;
      }
      .log-item {
        border-top: 1px solid #eceff8;
        padding-top: 10px;
        margin-top: 10px;
      }
      .progress-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 240px;
        background: #fff;
        border-radius: 14px;
        padding: 18px;
        z-index: 40;
        display: none;
      }
      .progress-dialog.show {
        display: block;
      }
      .spinner {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 3px solid #d0d7ff;
        border-top-color: #3f51b5;
        animation: spin 800ms linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <main class="screen">
      <header class="top-app-bar">
        <div>
          <h2 class="title" data-i18n="me_title">个人中心</h2>
          <div class="subtitle" data-i18n="me_subtitle">数据同步与日志</div>
        </div>
      </header>
      <div class="my-body">
        <article class="card">
          <div class="row">
            <img class="avatar" src="https://fastly.picsum.photos/id/861/200/200.jpg?hmac=UJSK-tjn1gjzSmwHWZhjpaGahNSBDQWpMoNvg8Bxy8k" alt="avatar" />
            <div>
              <strong id="accountName" data-i18n="not_logged_in">未登录</strong>
              <div class="muted" id="accountIdLine"></div>
              <div class="muted" id="profileBioLine"></div>
              <div class="muted"><span data-i18n="device_id">设备标识</span>: <span id="deviceIdText"></span></div>
            </div>
          </div>
          <div class="row" style="margin-top: 12px; gap: 8px; flex-wrap: wrap">
            <button class="btn primary ripple" id="syncBtn">
              <span class="material-symbols-outlined" style="font-size: 16px">cloud_sync</span>
              <span data-i18n="sync_to_cloud">同步到云端</span>
            </button>
            <button class="btn tonal ripple" id="pullBtn" data-i18n="pull_from_cloud">从云端拉取</button>
            <button class="btn text ripple" id="goSettingBtn" data-i18n="open_settings">前往设置</button>
          </div>
          <small class="muted" id="syncHint" data-i18n="sync_hint">可通过修改 localStorage device id 模拟多设备登录</small>
        </article>

        <article class="card log-card">
          <div class="row">
            <span class="material-symbols-outlined">schedule</span>
            <strong data-i18n="sync_logs">同步日志</strong>
          </div>
          <div id="logList"></div>
        </article>
      </div>
    </main>

    <div class="progress-backdrop" id="progressBackdrop"></div>
    <div class="progress-dialog" id="progressDialog">
      <div class="row">
        <div class="spinner"></div>
        <span data-i18n="syncing">正在同步数据...</span>
      </div>
    </div>

    <script src="./common.js"></script>
    <script src="./i18n.js"></script>
    <script>
      if (!BellMate.isAuthed()) BellMate.postToParent("require-auth", {});
      BellMate.ensureDevice();
      BellMate.ensureSeedData();
      BellMate.applyPreferences(document);
      BellMateI18n.apply(document);
      const t = (k, vars) => BellMateI18n.t(k, vars);

      const accountName = document.getElementById("accountName");
      const accountIdLine = document.getElementById("accountIdLine");
      const profileBioLine = document.getElementById("profileBioLine");
      const deviceIdText = document.getElementById("deviceIdText");
      const syncBtn = document.getElementById("syncBtn");
      const pullBtn = document.getElementById("pullBtn");
      const logList = document.getElementById("logList");
      const progressBackdrop = document.getElementById("progressBackdrop");
      const progressDialog = document.getElementById("progressDialog");
      const goSettingBtn = document.getElementById("goSettingBtn");
      const syncHint = document.getElementById("syncHint");

      function isGuest() {
        return BellMate.isGuestMode() || !BellMate.getAccount();
      }
      function showProgress(show) {
        progressBackdrop.classList.toggle("show", show);
        progressDialog.classList.toggle("show", show);
      }
      function resetProgress() {
        progressBackdrop.classList.remove("show");
        progressDialog.classList.remove("show");
      }
      function currentAccount() {
        return isGuest() ? t("guest_mode") : BellMate.getAccount() || t("not_logged_in");
      }
      function readProfile() {
        return BellMate.readJSON(BellMate.KEYS.profile, { nickname: "", phone: "", bio: "" }) || {
          nickname: "",
          phone: "",
          bio: "",
        };
      }
      function renderProfileSummary() {
        const guest = isGuest();
        const profile = readProfile();
        const account = BellMate.getAccount() || "";
        accountName.textContent = guest ? t("guest_mode") : profile.nickname || currentAccount();
        accountIdLine.textContent = guest ? "" : account ? `ID: ${account}` : "";
        const bioParts = [];
        if (!guest && profile.phone) bioParts.push(profile.phone);
        if (!guest && profile.bio) bioParts.push(profile.bio);
        profileBioLine.textContent = bioParts.join(" | ");
      }
      function applyGuestRestrictions() {
        const guest = isGuest();
        syncBtn.disabled = guest;
        pullBtn.disabled = guest;
        syncBtn.style.opacity = guest ? "0.6" : "1";
        pullBtn.style.opacity = guest ? "0.6" : "1";
        syncHint.textContent = guest ? t("sync_need_login") : t("sync_hint");
      }
      function getLogs() {
        return BellMate.readJSON(BellMate.KEYS.syncLogs, []);
      }
      function setLogs(logs) {
        BellMate.writeJSON(BellMate.KEYS.syncLogs, logs.slice(0, 20));
      }
      function appendLog(typeKey, count) {
        const logs = getLogs();
        logs.unshift({
          id: `log_${Date.now()}`,
          time: new Date().toLocaleString(),
          typeKey,
          count,
          device: localStorage.getItem(BellMate.KEYS.deviceId),
        });
        setLogs(logs);
      }
      function renderLogs() {
        const logs = getLogs();
        if (!logs.length) {
          logList.innerHTML = `<p class="muted">${t("no_logs")}</p>`;
          return;
        }
        logList.innerHTML = logs
          .map(
            (l) => `<div class="log-item">
              <div><strong>${t(l.typeKey)}</strong> · ${t("records_count", { count: l.count })}</div>
              <small class="muted">${l.time} · ${l.device}</small>
            </div>`
          )
          .join("");
      }

      function syncToCloud() {
        if (isGuest()) {
          BellMate.postToParent("toast", { message: t("sync_need_login") });
          return;
        }
        showProgress(true);
        setTimeout(() => {
          const payload = {
            alarms: BellMate.readJSON(BellMate.KEYS.alarms, []),
            plans: BellMate.readJSON(BellMate.KEYS.plans, []),
            syncedAt: Date.now(),
            device: localStorage.getItem(BellMate.KEYS.deviceId),
          };
          BellMate.writeJSON(BellMate.getCloudKey(BellMate.getAccount()), payload);
          appendLog("log_upload", payload.alarms.length + payload.plans.length);
          renderLogs();
          showProgress(false);
          BellMate.postToParent("toast", { message: t("sync_done") });
        }, 1200);
      }

      function pullFromCloud() {
        if (isGuest()) {
          BellMate.postToParent("toast", { message: t("sync_need_login") });
          return;
        }
        const cloud = BellMate.readJSON(BellMate.getCloudKey(BellMate.getAccount()), null);
        if (!cloud) return BellMate.postToParent("toast", { message: t("no_cloud_data") });
        BellMate.writeJSON(BellMate.KEYS.alarms, cloud.alarms || []);
        BellMate.writeJSON(BellMate.KEYS.plans, cloud.plans || []);
        appendLog("log_pull", (cloud.alarms || []).length + (cloud.plans || []).length);
        renderLogs();
        BellMate.postToParent("toast", { message: t("cloud_applied") });
      }

      syncBtn.addEventListener("click", syncToCloud);
      pullBtn.addEventListener("click", pullFromCloud);
      goSettingBtn.addEventListener("click", () => BellMate.postToParent("navigate", { route: "settings" }));

      window.addEventListener("message", (event) => {
        const data = event.data || {};
        if (data.source !== "bellmate-parent") return;
        if (data.type === "state-refresh") {
          resetProgress();
          BellMate.applyPreferences(document);
          BellMateI18n.apply(document);
          renderProfileSummary();
          applyGuestRestrictions();
          renderLogs();
        }
      });

      window.addEventListener("pageshow", resetProgress);
      resetProgress();
      renderProfileSummary();
      applyGuestRestrictions();
      deviceIdText.textContent = localStorage.getItem(BellMate.KEYS.deviceId);
      renderLogs();
    </script>
  </body>
</html>
