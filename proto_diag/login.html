<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BellMate 登录</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <link rel="stylesheet" href="./styles.css" />
    <style>
      body {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.82), rgba(246, 248, 255, 0.95)),
          url("https://picsum.photos/1080/2400?random=7") center/cover no-repeat;
      }
      .login-wrap {
        height: 100%;
        overflow: auto;
        padding: 24px 16px;
      }
      .hero {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      .avatar {
        width: 84px;
        height: 84px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 10px 26px rgba(34, 44, 90, 0.25);
        object-fit: cover;
      }
      .panel {
        margin-top: 16px;
        border-radius: 16px;
        border: 1px solid #e5e9fb;
        background: rgba(255, 255, 255, 0.94);
        padding: 16px;
      }
      .switcher {
        display: grid;
        grid-template-columns: 1fr 1fr;
        padding: 4px;
        border-radius: 999px;
        background: #ecefff;
        margin-bottom: 12px;
      }
      .switcher button {
        min-height: 36px;
        border: 0;
        border-radius: 999px;
        background: transparent;
        color: #3b4263;
        cursor: pointer;
      }
      .switcher button.active {
        background: #fff;
        color: #2a377e;
        box-shadow: 0 2px 8px rgba(59, 72, 140, 0.2);
      }
      .mode-panel {
        display: none;
      }
      .mode-panel.active {
        display: block;
      }
      .code-row {
        display: grid;
        grid-template-columns: 1fr 112px;
        gap: 8px;
      }
      .code-btn {
        border-radius: 12px;
        min-height: 44px;
        border: 0;
        color: #fff;
        background: #3f51b5;
        cursor: pointer;
      }
      .code-btn[disabled] {
        background: #96a2df;
        cursor: not-allowed;
      }
      .social-wrap {
        margin-top: 14px;
        border-top: 1px solid #eceffa;
        padding-top: 14px;
      }
      .social-btn {
        width: 100%;
        min-height: 44px;
        border-radius: 12px;
        border: 1px solid #d7defd;
        background: #fff;
        color: #2b366f;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
      }
      .social-btn + .social-btn {
        margin-top: 8px;
      }
      .footer-links {
        display: flex;
        justify-content: space-between;
        margin-top: 12px;
      }
    </style>
  </head>
  <body>
    <div class="login-wrap">
      <div class="hero">
        <img class="avatar" src="https://picsum.photos/200/200?random=1" alt="avatar" />
        <h2 class="title" style="margin: 0" data-i18n="app_name">BellMate</h2>
      </div>

      <section class="panel">
        <div id="loginView" class="mode-panel active">
          <div class="switcher" id="methodSwitcher">
            <button class="active ripple" data-method="account" data-i18n="login_account">账号密码</button>
            <button class="ripple" data-method="phone" data-i18n="login_phone">手机号</button>
          </div>

          <div id="accountForm">
            <div class="field">
              <label data-i18n="field_account">账号</label>
              <input id="accountName" data-i18n-placeholder="field_account" placeholder="账号" value="demo" />
            </div>
            <div class="field">
              <label data-i18n="field_password">密码</label>
              <input id="accountPwd" type="password" data-i18n-placeholder="field_password" placeholder="密码" value="123456" />
            </div>
            <button class="btn primary ripple" id="loginAccountBtn" style="width: 100%" data-i18n="login_btn">登录</button>
          </div>

          <div id="phoneForm" style="display: none">
            <div class="field">
              <label data-i18n="field_phone">手机号</label>
              <input id="phoneNum" data-i18n-placeholder="field_phone" placeholder="手机号" maxlength="11" />
            </div>
            <div class="field">
              <label data-i18n="field_code">验证码</label>
              <div class="code-row">
                <input id="phoneCode" data-i18n-placeholder="field_code" placeholder="验证码" maxlength="6" />
                <button id="sendCodeBtn" class="code-btn ripple" data-i18n="get_code">获取验证码</button>
              </div>
            </div>
            <button class="btn primary ripple" id="loginPhoneBtn" style="width: 100%" data-i18n="login_phone_btn">手机号登录</button>
          </div>

          <div class="social-wrap">
            <button class="social-btn ripple" id="wechatAuthBtn">
              <span class="material-symbols-outlined">chat</span>
              <span data-i18n="login_wechat">微信登录</span>
            </button>
            <button class="social-btn ripple" id="qqAuthBtn">
              <span class="material-symbols-outlined">forum</span>
              <span data-i18n="login_qq">QQ登录</span>
            </button>
          </div>

          <div class="footer-links">
            <button class="btn text ripple" id="openRegisterBtn" data-i18n="login_register">注册账号</button>
            <button class="btn text ripple" id="openForgotBtn" data-i18n="login_forgot">忘记密码</button>
          </div>
          <button class="btn text ripple" id="skipLoginBtn" style="width: 100%; margin-top: 6px" data-i18n="login_skip">
            暂不登录，先体验
          </button>
        </div>

        <div id="registerView" class="mode-panel">
          <h3 style="margin-top: 0" data-i18n="register_title">注册账号</h3>
          <div class="field">
            <label data-i18n="field_phone">手机号</label>
            <input id="regPhone" data-i18n-placeholder="field_phone" placeholder="手机号" maxlength="11" />
          </div>
          <div class="field">
            <label data-i18n="field_password">密码</label>
            <input id="regPwd" type="password" data-i18n-placeholder="field_password_hint" placeholder="至少6位" />
          </div>
          <button class="btn primary ripple" id="registerBtn" style="width: 100%" data-i18n="register_submit">提交注册</button>
          <button class="btn text ripple" id="backToLoginFromRegister" style="margin-top: 8px" data-i18n="login_back">返回登录</button>
        </div>

        <div id="forgotView" class="mode-panel">
          <h3 style="margin-top: 0" data-i18n="forgot_title">忘记密码</h3>
          <div class="field">
            <label data-i18n="field_phone">手机号</label>
            <input id="forgotPhone" data-i18n-placeholder="field_phone" placeholder="手机号" maxlength="11" />
          </div>
          <div class="field">
            <label data-i18n="field_new_password">新密码</label>
            <input id="forgotPwd" type="password" data-i18n-placeholder="field_new_password" placeholder="新密码" />
          </div>
          <button class="btn tonal ripple" id="resetPwdBtn" style="width: 100%" data-i18n="forgot_submit">重置密码</button>
          <button class="btn text ripple" id="backToLoginFromForgot" style="margin-top: 8px" data-i18n="login_back">返回登录</button>
        </div>
      </section>
    </div>

    <div class="dialog-backdrop" id="authBackdrop"></div>
    <div class="dialog" id="authDialog">
      <div class="row" style="align-items: center; gap: 8px; font-weight: 700">
        <span id="authLogo" class="material-symbols-outlined">chat</span>
        <span id="authTitle" data-i18n="auth_login_title">授权登录</span>
      </div>
      <p class="muted" data-i18n="auth_desc">BellMate 正在申请读取基础账号资料。</p>
      <div class="row" style="justify-content: flex-end; margin-top: 8px">
        <button class="btn text ripple" id="cancelAuthBtn" data-i18n="auth_cancel">取消</button>
        <button class="btn primary ripple" id="confirmAuthBtn" data-i18n="auth_confirm">确认授权</button>
      </div>
    </div>

    <script src="./common.js"></script>
    <script src="./i18n.js"></script>
    <script>
      const t = (k, vars) => BellMateI18n.t(k, vars);
      const loginView = document.getElementById("loginView");
      const registerView = document.getElementById("registerView");
      const forgotView = document.getElementById("forgotView");
      const methodSwitcher = Array.from(document.querySelectorAll("#methodSwitcher button"));
      const accountForm = document.getElementById("accountForm");
      const phoneForm = document.getElementById("phoneForm");
      const sendCodeBtn = document.getElementById("sendCodeBtn");
      const authBackdrop = document.getElementById("authBackdrop");
      const authDialog = document.getElementById("authDialog");
      const authTitle = document.getElementById("authTitle");
      const authLogo = document.getElementById("authLogo");
      let currentAuthProvider = "wechat";
      let codeSeconds = 0;
      let codeTimer = null;

      BellMate.applyPreferences(document);
      BellMateI18n.apply(document);

      function showView(name) {
        loginView.classList.toggle("active", name === "login");
        registerView.classList.toggle("active", name === "register");
        forgotView.classList.toggle("active", name === "forgot");
      }

      function switchMethod(method) {
        methodSwitcher.forEach((btn) => btn.classList.toggle("active", btn.dataset.method === method));
        accountForm.style.display = method === "account" ? "block" : "none";
        phoneForm.style.display = method === "phone" ? "block" : "none";
      }

      function saveToken(account) {
        const result = BellMate.login(account);
        if (!result.ok) {
          BellMate.postToParent("toast", { message: result.message || t("login_failed") });
          return;
        }
        BellMate.postToParent("auth-success", { account });
      }

      methodSwitcher.forEach((btn) => btn.addEventListener("click", () => switchMethod(btn.dataset.method)));

      document.getElementById("loginAccountBtn").addEventListener("click", () => {
        const account = (document.getElementById("accountName").value || "demo").trim();
        saveToken(account);
      });

      sendCodeBtn.addEventListener("click", () => {
        if (codeSeconds > 0) return;
        codeSeconds = 60;
        sendCodeBtn.disabled = true;
        sendCodeBtn.textContent = `${codeSeconds}s`;
        codeTimer = setInterval(() => {
          codeSeconds -= 1;
          sendCodeBtn.textContent = codeSeconds > 0 ? `${codeSeconds}s` : t("get_code");
          if (codeSeconds <= 0) {
            clearInterval(codeTimer);
            sendCodeBtn.disabled = false;
          }
        }, 1000);
      });

      document.getElementById("loginPhoneBtn").addEventListener("click", () => {
        const phone = document.getElementById("phoneNum").value.trim();
        const code = document.getElementById("phoneCode").value.trim();
        if (!/^\d{11}$/.test(phone) || !/^\d{6}$/.test(code)) {
          BellMate.postToParent("toast", { message: t("invalid_phone_code") });
          return;
        }
        saveToken(`phone_${phone}`);
      });

      function openAuth(provider) {
        currentAuthProvider = provider;
        authTitle.textContent = provider === "wechat" ? t("auth_wechat_title") : t("auth_qq_title");
        authLogo.textContent = provider === "wechat" ? "chat" : "forum";
        authBackdrop.classList.add("show");
        authDialog.classList.add("show");
      }

      function closeAuth() {
        authBackdrop.classList.remove("show");
        authDialog.classList.remove("show");
      }

      document.getElementById("wechatAuthBtn").addEventListener("click", () => openAuth("wechat"));
      document.getElementById("qqAuthBtn").addEventListener("click", () => openAuth("qq"));
      document.getElementById("cancelAuthBtn").addEventListener("click", closeAuth);
      document.getElementById("confirmAuthBtn").addEventListener("click", () => {
        closeAuth();
        saveToken(`${currentAuthProvider}_user`);
      });
      authBackdrop.addEventListener("click", closeAuth);

      document.getElementById("openRegisterBtn").addEventListener("click", () => showView("register"));
      document.getElementById("openForgotBtn").addEventListener("click", () => showView("forgot"));
      document.getElementById("backToLoginFromRegister").addEventListener("click", () => showView("login"));
      document.getElementById("backToLoginFromForgot").addEventListener("click", () => showView("login"));
      document.getElementById("skipLoginBtn").addEventListener("click", () => {
        BellMate.enableGuestMode();
        BellMate.postToParent("auth-success", { account: "guest", guest: true });
      });

      document.getElementById("registerBtn").addEventListener("click", () => {
        const phone = document.getElementById("regPhone").value.trim();
        const pwd = document.getElementById("regPwd").value.trim();
        if (!/^\d{11}$/.test(phone) || pwd.length < 6) {
          BellMate.postToParent("toast", { message: t("register_invalid") });
          return;
        }
        BellMate.postToParent("toast", { message: t("register_ok") });
        showView("login");
      });

      document.getElementById("resetPwdBtn").addEventListener("click", () => {
        const phone = document.getElementById("forgotPhone").value.trim();
        const pwd = document.getElementById("forgotPwd").value.trim();
        if (!/^\d{11}$/.test(phone) || pwd.length < 6) {
          BellMate.postToParent("toast", { message: t("reset_invalid") });
          return;
        }
        BellMate.postToParent("toast", { message: t("reset_ok") });
        showView("login");
      });

      window.addEventListener("message", (event) => {
        const data = event.data || {};
        if (data.source !== "bellmate-parent") return;
        if (data.type === "host-route" && data.payload.route === "login" && BellMate.isAuthed()) {
          BellMate.postToParent("navigate", { route: "alarm" });
        }
        if (data.type === "state-refresh") {
          BellMate.applyPreferences(document);
          BellMateI18n.apply(document);
          if (codeSeconds <= 0) sendCodeBtn.textContent = t("get_code");
        }
      });
    </script>
  </body>
</html>
